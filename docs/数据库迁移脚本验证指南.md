# 数据库迁移脚本验证指南

## 🎯 概述

本指南介绍如何使用数据库迁移脚本验证工具来确保Flyway迁移脚本的正确性，验证脚本是否会按照正确的顺序执行且不存在冲突或重复。

## 📋 验证内容

验证工具会检查以下内容：

### 1. 版本号冲突检测
- ✅ 检查是否存在重复的版本号
- ✅ 确保每个版本号只对应一个迁移脚本
- ✅ 识别可能导致Flyway执行失败的冲突

### 2. 执行顺序验证
- ✅ 按版本号升序生成执行顺序
- ✅ 确保迁移脚本按预期顺序执行
- ✅ 验证模块间依赖关系

### 3. 表依赖关系检查
- ✅ 检查外键引用的表是否在引用前已创建
- ✅ 验证表创建的逻辑顺序
- ✅ 识别可能的循环依赖

### 4. SQL语法验证
- ✅ 检查外键检查开关配对（SET FOREIGN_KEY_CHECKS）
- ✅ 验证常见的SQL最佳实践
- ✅ 检查字符集配置

### 5. 模块结构分析
- ✅ 分析各模块的迁移脚本分布
- ✅ 验证版本号范围分配
- ✅ 检查模块间的协调性

## 🚀 使用方法

### 方法1：使用批处理脚本（推荐）

```bash
# 在项目根目录下运行
scripts\validate-migrations.bat
```

### 方法2：直接运行Python脚本

```bash
# 基本验证
python scripts/migration-validator.py

# 指定扫描路径
python scripts/migration-validator.py ./law-firm-modules
```

### 方法3：使用PowerShell脚本

```powershell
# 基本验证
.\scripts\migration-validator.ps1

# 显示详细信息
.\scripts\migration-validator.ps1 -ShowDetails

# 导出JSON报告
.\scripts\migration-validator.ps1 -ExportJson
```

## 📊 验证结果说明

### 成功验证
```
🎉 验证通过！迁移脚本可以安全执行。
```
- 表示所有检查都通过
- 迁移脚本可以安全执行
- 没有发现任何冲突或错误

### 发现问题
```
⚠️  发现问题，建议修复后再执行迁移。
```
- 发现了需要修复的问题
- 详细错误信息会显示在控制台
- 建议修复后重新验证

## 🔧 常见问题及解决方案

### 1. 版本号冲突

**问题描述**：
```
❌ 版本号冲突 V12001: V12001__schedule_tables.sql, V12001__schedule_tables.sql
```

**解决方案**：
- 检查是否有重复的文件
- 确保每个版本号唯一
- 重新分配冲突的版本号

### 2. 表依赖问题

**问题描述**：
```
❌ 依赖问题: V13001__task_tables.sql 中 task_content 引用了未创建的表 task_task
```

**解决方案**：
- 调整表创建顺序
- 确保被引用的表先创建
- 检查外键约束的正确性

### 3. 外键检查未恢复

**问题描述**：
```
❌ 禁用了外键检查但未恢复
```

**解决方案**：
```sql
-- 在脚本开头
SET FOREIGN_KEY_CHECKS = 0;

-- 在脚本结尾必须添加
SET FOREIGN_KEY_CHECKS = 1;
```

### 4. 字符集配置问题

**问题描述**：
```
⚠️  V12001__schedule_tables.sql: 建议使用utf8mb4字符集
```

**解决方案**：
```sql
-- 确保表定义包含字符集配置
CREATE TABLE example_table (
    -- 字段定义
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 📁 文件结构说明

### 迁移脚本位置
```
law-firm-infra/
├── law-firm-api/src/main/resources/META-INF/db/migration/
│   ├── V0001__init_base_tables.sql
│   ├── V0002__init_base_data.sql
│   └── V0003__module_description.sql
├── law-firm-core/*/src/main/resources/META-INF/db/migration/
│   ├── V0050__init_audit_tables.sql
│   ├── V0055__init_storage_tables.sql
│   └── ...
└── law-firm-modules/*/src/main/resources/META-INF/db/migration/
    ├── V1000__system_module_description.sql
    ├── V2001__init_auth_tables.sql
    └── ...
```

### 版本号规范
- **API层**: V0001-V0999
- **Core层**: V0050-V0099 (每个模块5个版本号)
- **业务模块**: V1000+ (每个模块1000个版本号)

## 📈 报告解读

### 控制台输出
```
📋 数据库迁移脚本验证摘要
============================================================
📁 总文件数: 51
❌ 错误数: 0
⚠️  警告数: 2
🔄 版本冲突: 0

📊 模块分布:
   law-firm-api: 3 个文件, 版本范围: V1-V3
   law-firm-core: 6 个文件, 版本范围: V50-V75
   law-firm-modules: 42 个文件, 版本范围: V1000-V14002
```

### JSON报告文件
验证工具会生成 `migration-validation-report.json` 文件，包含：
- 详细的验证结果
- 所有迁移文件列表
- 执行顺序信息
- 错误和警告详情
- 模块统计信息

## 🛠️ 集成到CI/CD

### 在构建流程中添加验证

```yaml
# GitHub Actions 示例
name: Database Migration Validation
on: [push, pull_request]

jobs:
  validate-migrations:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'
    - name: Validate Migration Scripts
      run: python scripts/migration-validator.py
```

### Maven构建集成

```xml
<plugin>
    <groupId>org.codehaus.mojo</groupId>
    <artifactId>exec-maven-plugin</artifactId>
    <executions>
        <execution>
            <id>validate-migrations</id>
            <phase>validate</phase>
            <goals>
                <goal>exec</goal>
            </goals>
            <configuration>
                <executable>python</executable>
                <arguments>
                    <argument>scripts/migration-validator.py</argument>
                </arguments>
            </configuration>
        </execution>
    </executions>
</plugin>
```

## 🎯 最佳实践

### 1. 验证时机
- 🔄 每次提交前验证
- 🔄 合并代码前验证
- 🔄 部署前验证
- 🔄 定期自动验证

### 2. 版本号管理
- 📋 使用统一的版本号规范
- 📋 预留足够的版本号空间
- 📋 避免版本号回退或跳跃

### 3. 依赖管理
- 🔗 明确表创建顺序
- 🔗 避免循环依赖
- 🔗 文档化依赖关系

### 4. 脚本质量
- ✅ 使用标准化的脚本模板
- ✅ 添加详细的注释说明
- ✅ 遵循SQL编码规范

## 🚨 注意事项

1. **备份数据**：在执行迁移前确保数据已备份
2. **测试环境**：先在测试环境验证迁移脚本
3. **权限控制**：确保数据库用户有足够权限
4. **监控日志**：关注Flyway执行日志
5. **回滚计划**：准备必要的回滚方案

## 📞 支持与反馈

如果遇到问题或有改进建议：
1. 检查本文档的常见问题部分
2. 查看验证工具生成的详细报告
3. 联系数据库团队寻求支持

---

**版本**: 1.0.0  
**更新时间**: 2025-01-07  
**维护团队**: 数据库管理团队 