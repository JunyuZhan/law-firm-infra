<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lawfirm.model.auth.mapper.PermissionMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.lawfirm.model.auth.entity.Permission">
        <id column="id" property="id"/>
        <result column="permission_name" property="permissionName"/>
        <result column="permission_code" property="permissionCode"/>
        <result column="permission_type" property="permissionType"/>
        <result column="parent_id" property="parentId"/>
        <result column="path" property="path"/>
        <result column="component" property="component"/>
        <result column="icon" property="icon"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="status" property="status"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="created_by" property="createdBy"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_by" property="updatedBy"/>
        <result column="updated_time" property="updatedTime"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, permission_name, permission_code, permission_type, parent_id, path, component, icon, 
        sort_order, status, tenant_id, created_by, created_time, updated_by, updated_time, deleted
    </sql>

    <!-- 根据ID查询权限 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM auth_permission
        WHERE id = #{id} AND deleted = 0
    </select>

    <!-- 查询所有权限 -->
    <select id="selectAll" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM auth_permission
        WHERE deleted = 0
        ORDER BY sort_order ASC
    </select>

    <!-- 根据父ID查询子权限 -->
    <select id="selectByParentId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM auth_permission
        WHERE parent_id = #{parentId} AND deleted = 0
        ORDER BY sort_order ASC
    </select>

    <!-- 根据角色ID查询权限 -->
    <select id="selectByRoleId" resultMap="BaseResultMap">
        SELECT p.*
        FROM auth_permission p
        JOIN auth_role_permission rp ON p.id = rp.permission_id
        WHERE rp.role_id = #{roleId} AND p.deleted = 0
        ORDER BY p.sort_order ASC
    </select>

    <!-- 根据用户ID查询权限 -->
    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT DISTINCT p.*
        FROM auth_permission p
        JOIN auth_role_permission rp ON p.id = rp.permission_id
        JOIN auth_user_role ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = #{userId} AND p.deleted = 0
        ORDER BY p.sort_order ASC
    </select>

    <!-- 根据类型查询权限 -->
    <select id="selectByType" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM auth_permission
        WHERE permission_type = #{permissionType} AND deleted = 0
        ORDER BY sort_order ASC
    </select>

    <!-- 新增权限 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO auth_permission (
            permission_name, permission_code, permission_type, parent_id, path, component, icon, 
            sort_order, status, tenant_id, created_by, updated_by
        ) VALUES (
            #{permissionName}, #{permissionCode}, #{permissionType}, #{parentId}, #{path}, #{component}, 
            #{icon}, #{sortOrder}, #{status}, #{tenantId}, #{createdBy}, #{updatedBy}
        )
    </insert>

    <!-- 更新权限 -->
    <update id="update">
        UPDATE auth_permission
        <set>
            <if test="permissionName != null">permission_name = #{permissionName},</if>
            <if test="permissionCode != null">permission_code = #{permissionCode},</if>
            <if test="permissionType != null">permission_type = #{permissionType},</if>
            <if test="parentId != null">parent_id = #{parentId},</if>
            <if test="path != null">path = #{path},</if>
            <if test="component != null">component = #{component},</if>
            <if test="icon != null">icon = #{icon},</if>
            <if test="sortOrder != null">sort_order = #{sortOrder},</if>
            <if test="status != null">status = #{status},</if>
            updated_by = #{updatedBy},
            updated_time = NOW()
        </set>
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 删除权限（逻辑删除） -->
    <update id="deleteById">
        UPDATE auth_permission
        SET deleted = 1, updated_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 批量删除权限（逻辑删除） -->
    <update id="deleteBatchByIds">
        UPDATE auth_permission
        SET deleted = 1, updated_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 更新权限状态 -->
    <update id="updateStatus">
        UPDATE auth_permission
        SET status = #{status}, updated_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>
</mapper>
