<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lawfirm.model.workflow.mapper.CommonProcessMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.lawfirm.model.workflow.entity.common.CommonProcess">
        <!-- 继承BaseProcess的字段 -->
        <id column="id" property="id" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="create_by" property="createBy" />
        <result column="update_by" property="updateBy" />
        <result column="deleted" property="deleted" />
        <result column="process_no" property="processNo" />
        <result column="process_name" property="processName" />
        <result column="process_type" property="processType" />
        <result column="status" property="status" />
        <result column="description" property="description" />
        <result column="business_id" property="businessId" />
        <result column="business_type" property="businessType" />
        <result column="initiator_id" property="initiatorId" />
        <result column="initiator_name" property="initiatorName" />
        <result column="start_time" property="startTime" />
        <result column="end_time" property="endTime" />
        <result column="current_handler_id" property="currentHandlerId" />
        <result column="current_handler_name" property="currentHandlerName" />
        <result column="priority" property="priority" />
        <result column="allow_revoke" property="allowRevoke" />
        <result column="allow_transfer" property="allowTransfer" />
        <result column="process_config" property="processConfig" />
        
        <!-- CommonProcess特有的字段 -->
        <result column="category" property="category" />
        <result column="tags" property="tags" />
        <result column="template_id" property="templateId" />
        <result column="template_version" property="templateVersion" />
        <result column="variables" property="variables" />
        <result column="form_data" property="formData" />
        <result column="attachment_ids" property="attachmentIds" />
        <result column="notes" property="notes" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, create_time, update_time, create_by, update_by, deleted,
        process_no, process_name, process_type, status, description, business_id, business_type,
        initiator_id, initiator_name, start_time, end_time, current_handler_id, current_handler_name,
        priority, allow_revoke, allow_transfer, process_config,
        category, tags, template_id, template_version, variables, form_data, attachment_ids, notes
    </sql>

    <!-- 根据模板ID查询流程 -->
    <select id="selectByTemplateId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM workflow_process
        WHERE template_id = #{templateId}
        AND deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 根据分类查询流程 -->
    <select id="selectByCategory" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM workflow_process
        WHERE category = #{category}
        AND deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 根据标签查询流程 -->
    <select id="selectByTag" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM workflow_process
        WHERE tags LIKE CONCAT('%', #{tag}, '%')
        AND deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 根据模板ID和状态统计流程数量 -->
    <select id="countByTemplateAndStatus" resultType="java.util.Map">
        SELECT
            template_id,
            status,
            COUNT(1) as count
        FROM workflow_process
        WHERE template_id = #{templateId}
        AND deleted = 0
        GROUP BY status
    </select>

    <!-- 查询最近的流程 -->
    <select id="selectRecentProcesses" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM workflow_process
        WHERE deleted = 0
        ORDER BY create_time DESC
        LIMIT #{limit}
    </select>

</mapper> 