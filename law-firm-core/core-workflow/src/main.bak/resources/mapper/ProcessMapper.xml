<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lawfirm.core.workflow.mapper.ProcessMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.lawfirm.core.workflow.entity.ProcessInstance">
        <id column="id" property="id" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="create_by" property="createBy" />
        <result column="update_by" property="updateBy" />
        <result column="deleted" property="deleted" />
        <result column="process_no" property="processNo" />
        <result column="process_name" property="processName" />
        <result column="process_type" property="processType" />
        <result column="status" property="status" />
        <result column="description" property="description" />
        <result column="business_id" property="businessId" />
        <result column="business_type" property="businessType" />
        <result column="initiator_id" property="initiatorId" />
        <result column="initiator_name" property="initiatorName" />
        <result column="start_time" property="startTime" />
        <result column="end_time" property="endTime" />
        <result column="current_handler_id" property="currentHandlerId" />
        <result column="current_handler_name" property="currentHandlerName" />
        <result column="priority" property="priority" />
        <result column="allow_revoke" property="allowRevoke" />
        <result column="allow_transfer" property="allowTransfer" />
        <result column="process_config" property="processConfig" />
        <!-- ProcessInstance特有字段 -->
        <result column="process_instance_id" property="processInstanceId" />
        <result column="process_definition_id" property="processDefinitionId" />
        <result column="process_definition_key" property="processDefinitionKey" />
        <result column="process_definition_name" property="processDefinitionName" />
        <result column="process_definition_version" property="processDefinitionVersion" />
        <result column="deployment_id" property="deploymentId" />
        <result column="business_key" property="businessKey" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, create_time, update_time, create_by, update_by, deleted,
        process_no, process_name, process_type, status, description, business_id, business_type,
        initiator_id, initiator_name, start_time, end_time, current_handler_id, current_handler_name,
        priority, allow_revoke, allow_transfer, process_config,
        process_instance_id, process_definition_id, process_definition_key, process_definition_name,
        process_definition_version, deployment_id, business_key
    </sql>
    
    <!-- 根据流程实例ID查询流程 -->
    <select id="selectByProcessInstanceId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM workflow_process_instance
        WHERE process_instance_id = #{processInstanceId}
        AND deleted = 0
    </select>
    
    <!-- 根据查询条件查询流程列表 -->
    <select id="selectByCondition" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM workflow_process_instance
        <where>
            deleted = 0
            <if test="query.processName != null and query.processName != ''">
                AND process_name LIKE CONCAT('%', #{query.processName}, '%')
            </if>
            <if test="query.processType != null">
                AND process_type = #{query.processType}
            </if>
            <if test="query.status != null">
                AND status = #{query.status}
            </if>
            <if test="query.businessType != null and query.businessType != ''">
                AND business_type = #{query.businessType}
            </if>
            <if test="query.businessId != null and query.businessId != ''">
                AND business_id = #{query.businessId}
            </if>
            <if test="query.initiatorId != null and query.initiatorId != ''">
                AND initiator_id = #{query.initiatorId}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>
    
    <!-- 根据查询条件分页查询流程 -->
    <select id="selectPageByCondition" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM workflow_process_instance
        <where>
            deleted = 0
            <if test="query.processName != null and query.processName != ''">
                AND process_name LIKE CONCAT('%', #{query.processName}, '%')
            </if>
            <if test="query.processType != null">
                AND process_type = #{query.processType}
            </if>
            <if test="query.status != null">
                AND status = #{query.status}
            </if>
            <if test="query.businessType != null and query.businessType != ''">
                AND business_type = #{query.businessType}
            </if>
            <if test="query.businessId != null and query.businessId != ''">
                AND business_id = #{query.businessId}
            </if>
            <if test="query.initiatorId != null and query.initiatorId != ''">
                AND initiator_id = #{query.initiatorId}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>
    
    <!-- 查询当前处理人的流程 -->
    <select id="selectCurrentHandlerProcesses" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM workflow_process_instance
        WHERE current_handler_id = #{handlerId}
        AND deleted = 0
        ORDER BY priority DESC, create_time ASC
    </select>

    <!-- 根据业务ID和业务类型查询流程 -->
    <select id="selectByBusinessIdAndType" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM workflow_process_instance
        WHERE business_id = #{businessId}
        AND business_type = #{businessType}
        AND deleted = 0
    </select>

    <!-- 查询用户发起的流程 -->
    <select id="selectByInitiator" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM workflow_process_instance
        WHERE initiator_id = #{initiatorId}
        AND deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 查询用户待处理的流程 -->
    <select id="selectPendingByHandler" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM workflow_process_instance
        WHERE current_handler_id = #{handlerId}
        AND status IN (1, 2) <!-- 执行中的状态 -->
        AND deleted = 0
        ORDER BY priority DESC, create_time ASC
    </select>

    <!-- 统计各状态流程数量 -->
    <select id="countByStatus" resultType="java.util.Map">
        SELECT
            status,
            COUNT(1) as count
        FROM workflow_process_instance
        WHERE deleted = 0
        GROUP BY status
    </select>

</mapper> 